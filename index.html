<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JA Finished Goods Scanner</title>
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    label { display: block; margin-top: 1rem; }
    input, select { width: 100%; padding: 0.5rem; }
    button { margin-top: 1rem; padding: 0.75rem; width: 100%; font-weight: bold; }
    #scanner { width: 100%; max-height: 160px; margin: 0.5rem 0; border: 2px solid #555; border-radius: 6px; position: relative; }
    textarea { width: 100%; height: 100px; margin-top: 1rem; }
  
  input.flash {
    border: 2px solid lime !important;
    box-shadow: 0 0 6px lime;
  }


  html, body {
    overflow-x: hidden;
    max-width: 100vw;
  }

</style>

<style>
  body.dark { background-color: #121212; color: #f0f0f0; }
  input, select, button, textarea { background-color: #222; color: #fff; border: 1px solid #444; }
  .toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 1rem;
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  .toast.show {
    visibility: visible;
    opacity: 1;
  }

  input.flash {
    border: 2px solid lime !important;
    box-shadow: 0 0 6px lime;
  }


  html, body {
    overflow-x: hidden;
    max-width: 100vw;
  }

</style>
<div id="toast" class="toast">Scanned!</div>
<script>
  function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
  }
</script>

</head>
<body>
  <h1>JA Finished Goods Inventory</h1>

  <div>
    <p><strong>Scan Step:</strong> <span id="scanStepLabel">SKU</span></p>
    <div id="scanner"></div>
    
    <div style="display: flex; gap: 0.5rem;">
      <button style='flex: 1; font-size: 0.9rem;' onclick="startScanner()">Start</button>
      <button style='flex: 1; font-size: 0.9rem;' onclick="stopScanner()">Stop</button>
    </div>
    

    <label><input type="checkbox" id="keepSKU" /> Keep same SKU for next entry</label>
    <label><input type="checkbox" id="keepSecondLot" /> Keep same ITEM RECEIPT SECOND LOT</label>

    <label>SKU:<input id="sku" /></label>
    <label>Production Lot:<input id="lot" /></label>
    <label>Product ID Tag:<input id="productIdTag" /></label>
    <label>Quantity:<input id="quantity" value="1" type="number" /></label>
    <label>ITEM RECEIPT SECOND LOT:<input id="secondLot" /></label>
    <label>Location:<input id="location" oninput="formatLocation(this)" /></label>
    <label>Warehouse:<input id="warehouse" value="GLENDALE" /></label>

    <button onclick="addEntry()">Add Entry</button>
    <button onclick="downloadCSV()">Download CSV</button>
  </div>

  <textarea id="csvPreview" readonly placeholder="CSV preview will appear here..."></textarea>

  <script>
    let entries = [];
    let scanStep = 0;
    const scanFields = ['sku', 'lot', 'productIdTag'];

    function formatLocation(el) {
      const val = el.value.replace(/^JA-/, '');
      el.value = 'JA-' + val;
    }

    function startScanner() {
      document.getElementById('scanStepLabel').innerText = scanFields[scanStep].toUpperCase();
      Quagga.init({
        inputStream: {
          name: 'Live',
          type: 'LiveStream',
          target: document.querySelector('#scanner'),
        },
        decoder: {
          readers: ['code_128_reader', 'ean_reader', 'ean_8_reader'],
        },
      }, err => {
        if (err) return console.error(err);
        Quagga.start();
      });

      
      document.activeElement.blur(); // prevent keyboard locking
      Quagga.onDetected(result => {
    
        const code = result.codeResult.code;
        const field = scanFields[scanStep];
        
        const el = document.getElementById(field);
        el.value = code;
        el.classList.add('flash');
        setTimeout(() => el.classList.remove('flash'), 700);
        showToast(`Scanned: ${field.toUpperCase()}`);
    
        if (scanStep === scanFields.length - 1) {
          stopScanner();
      } else {
          scanStep++;
          document.getElementById('scanStepLabel').innerText = scanFields[scanStep].toUpperCase();
      }
        // handled by logic above
        document.getElementById('scanStepLabel').innerText = scanFields[scanStep].toUpperCase();
      });
    }

    function stopScanner() {
      Quagga.stop();
    }

    function addEntry() {
      const row = {
        sku: document.getElementById('sku').value,
        lot: document.getElementById('lot').value,
        productIdTag: document.getElementById('productIdTag').value,
        quantity: document.getElementById('quantity').value,
        secondLot: document.getElementById('secondLot').value,
        location: document.getElementById('location').value,
        warehouse: document.getElementById('warehouse').value,
      };
      entries.push(row);
      updateCSVPreview();

      const keepSKU = document.getElementById('keepSKU').checked;
      const keepSecondLot = document.getElementById('keepSecondLot').checked;

      if (!keepSKU) document.getElementById('sku').value = '';
      document.getElementById('lot').value = '';
      document.getElementById('productIdTag').value = '';
      document.getElementById('quantity').value = '1';
      if (!keepSecondLot) document.getElementById('secondLot').value = '';
      document.getElementById('location').value = '';
      scanStep = 0;
      scanStep = 0;
      document.getElementById('scanStepLabel').innerText = scanFields[scanStep].toUpperCase();

      alert('Entry added!');
    }

    function updateCSVPreview() {
      const header = 'LOB,ITEM RECEIPT PO NUMBER,SKU,PRODUCTION LOT,PRODUCT ID TAG,QUANTITY,ITEM RECEIPT SECOND LOT,LOCATION,WAREHOUSE';
      const rows = entries.map(e =>
        `JA Solar - Expeditors,,${e.sku},${e.lot},${e.productIdTag},${e.quantity},${e.secondLot},${e.location},${e.warehouse}`
      );
      document.getElementById('csvPreview').value = [header, ...rows].join('\n');
    }

    function downloadCSV() {
      const date = new Date();
      const filename = `JA FINISHED GOODS IB ${date.toLocaleDateString('en-US', {
        month: '2-digit', day: '2-digit', year: '2-digit'
      }).replaceAll('/', '-')}.csv`;

      const csvContent = document.getElementById('csvPreview').value;
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>